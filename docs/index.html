<!DOCTYPE html>
<html>
<head>
    <title>Anime Tracker Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .anime-card {
            transition: transform 0.2s;
        }
        .anime-card:hover {
            transform: scale(1.02);
        }
        .progress {
            height: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="text-center mb-4">My Anime Tracker</h1>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="search" class="form-control" placeholder="Search anime...">
            </div>
            <div class="col-md-4">
                <select id="sort" class="form-select">
                    <option value="progress">Sort by Progress</option>
                    <option value="title">Sort by Title</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="refresh" class="btn btn-primary w-100">Refresh</button>
            </div>
        </div>
        
        <div id="loading" class="text-center my-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <div id="anime-list" class="row"></div>
    </div>

    <script>
        const CONFIG = {
            gistId: 'YOUR_GIST_ID',
            fileName: 'anime_tracker.json',
            githubUser: 'YOUR_USERNAME'
        };

        let allAnime = [];
        
        async function loadData() {
            try {
                showLoading(true);
                
                // Try direct Gist URL first
                let response = await fetch(`https://gist.githubusercontent.com/${CONFIG.githubUser}/${CONFIG.gistId}/raw/${CONFIG.fileName}`);
                
                if (!response.ok) {
                    // Fallback to API
                    response = await fetch(`https://api.github.com/gists/${CONFIG.gistId}`);
                    const data = await response.json();
                    renderAnime(JSON.parse(data.files[CONFIG.fileName].content));
                } else {
                    renderAnime(await response.json());
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to load data. Check console for details.");
            } finally {
                showLoading(false);
            }
        }
        
        function renderAnime(animeData) {
            allAnime = Object.values(animeData)
                .filter(a => a.IsTracking)
                .sort((a, b) => b.LastWatchedEpisode - a.LastWatchedEpisode);
                
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('anime-list');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const sortBy = document.getElementById('sort').value;
            
            let filtered = [...allAnime];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(anime => 
                    anime.Title.toLowerCase().includes(searchTerm) ||
                    (anime.EnglishTitle && anime.EnglishTitle.toLowerCase().includes(searchTerm)));
            }
            
            // Apply sorting
            if (sortBy === 'title') {
                filtered.sort((a, b) => a.Title.localeCompare(b.Title));
            } else {
                filtered.sort((a, b) => 
                    (b.LastWatchedEpisode / (b.TotalEpisodes || 1)) - 
                    (a.LastWatchedEpisode / (a.TotalEpisodes || 1)));
            }
            
            // Render cards
            filtered.forEach(anime => {
                const progress = (anime.LastWatchedEpisode / (anime.TotalEpisodes || 1)) * 100;
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                card.innerHTML = `
                    <div class="anime-card card h-100">
                        <img src="${anime.CoverImageUrl}" class="card-img-top" alt="${anime.Title}">
                        <div class="card-body">
                            <h5 class="card-title">${anime.Title}</h5>
                            <p class="card-text">
                                <small class="text-muted">${anime.Status}</small>
                            </p>
                            <div class="progress mb-3">
                                <div class="progress-bar" 
                                     role="progressbar" 
                                     style="width: ${progress}%" 
                                     aria-valuenow="${anime.LastWatchedEpisode}" 
                                     aria-valuemax="${anime.TotalEpisodes || '?'}">
                                </div>
                            </div>
                            <p>Episodes: ${anime.LastWatchedEpisode}/${anime.TotalEpisodes || '?'}</p>
                            <a href="${anime.AnimeUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                                View on AniList
                            </a>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Event listeners
        document.getElementById('search').addEventListener('input', updateDisplay);
        document.getElementById('sort').addEventListener('change', updateDisplay);
        document.getElementById('refresh').addEventListener('click', loadData);
        
        // Initial load
        loadData();
    </script>
</body>
</html>